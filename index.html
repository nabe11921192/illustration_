<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>6枠画像エディタ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      background-color: #f9f9f9;
    }
    .toolbar {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }
    button {
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(3, 370px);
      grid-template-rows: repeat(2, 340px);
      gap: 40px 10px;
      justify-content: center;
      margin: 140px auto 20px auto;
    }
    .box {
      position: relative;
      border: 2px dashed #999;
      background-color: #eee;
      width: 370px;
      height: 320px;
    }
    .label {
      display: block;
      width: 100%;
      text-align: center;
      font-size: 14px;
      margin-top: 4px;
    }
    #imageHolder {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px;
      justify-content: center;
    }
    #saveAll {
      display: block;
      margin: 20px auto;
      font-size: 18px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>

<div class="toolbar">
  <button onclick="resetAll()">リセット</button>
  <button onclick="changeLabels(-6)">< 戻る</button>
  <button onclick="changeLabels(6)">進む ></button>
</div>

<h2 style="text-align:center;">画像を6つの枠にドラッグ＆ドロップ、編集</h2>
<div class="container" id="canvasContainer"></div>

<input type="file" id="fileInput" multiple onchange="loadImages(event)">
<div id="imageHolder"></div>

<button id="saveAll" onclick="saveAllImages()">編集後の一括保存（PNG/1MB制限）</button>

<script>
let labelOffset = 0;
const boxCount = 6;
const canvases = [];

function createBoxes() {
  const container = document.getElementById('canvasContainer');
  container.innerHTML = '';
  canvases.length = 0;
  for (let i = 0; i < boxCount; i++) {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.alignItems = 'center';

    const div = document.createElement('div');
    div.className = 'box';
    div.id = 'box' + i;

    const canvasEl = document.createElement('canvas');
    canvasEl.width = 370;
    canvasEl.height = 320;
    canvasEl.id = 'canvas' + i;
    div.appendChild(canvasEl);
    wrapper.appendChild(div);

    const label = document.createElement('input');
    label.className = 'label';
    label.value = (i + 1 + labelOffset).toString();
    wrapper.appendChild(label);
    container.appendChild(wrapper);

    const fabricCanvas = new fabric.Canvas(canvasEl.id, {
      selection: true,
      preserveObjectStacking: true
    });
    canvases.push(fabricCanvas);

    // ドラッグ&ドロップイベント
    div.ondragover = e => e.preventDefault();
    div.ondrop = function(e) {
      e.preventDefault();
      const imgId = e.dataTransfer.getData("imgId");
      const imgEl = document.getElementById(imgId);
      const newImg = new Image();
      newImg.onload = () => {
        const fabricImg = new fabric.Image(newImg, {
          left: 0,
          top: 0,
          scaleX: 370 / newImg.width,
          scaleY: 320 / newImg.height,
          angle: 0,
          hasRotatingPoint: true,
          cornerStyle: 'circle',
          cornerColor: 'blue'
        });
        fabricCanvas.add(fabricImg);
        fabricCanvas.setActiveObject(fabricImg);
      };
      newImg.src = imgEl.src;
    };

    // バックスペースで削除
    fabricCanvas.on('mouse:down', function(opt) {
      fabricCanvas.setActiveObject(opt.target);
    });

    window.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace') {
        const active = fabricCanvas.getActiveObject();
        if (active) {
          fabricCanvas.remove(active);
        }
      }
    });

    // クリックで最前面へ
    fabricCanvas.on('mouse:down', function(opt) {
      if (opt.target) {
        opt.target.bringToFront();
        fabricCanvas.setActiveObject(opt.target);
      }
    });
  }
}

function loadImages(e) {
  const files = e.target.files;
  const holder = document.getElementById("imageHolder");
  holder.innerHTML = "";
  Array.from(files).forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = function(evt) {
      const img = document.createElement("img");
      img.src = evt.target.result;
      img.id = "img" + i;
      img.draggable = true;
      img.style.width = "100px";
      img.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("imgId", img.id);
      });
      holder.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
}

function resetAll() {
  createBoxes();
}

function changeLabels(diff) {
  labelOffset += diff;
  const inputs = document.querySelectorAll('.label');
  inputs.forEach((input, i) => input.value = (i + 1 + labelOffset).toString());
}

function dataURLToBlob(dataurl) {
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
  bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
  return new Blob([u8arr], {type:mime});
}

function saveAllImages() {
  const zip = new JSZip();
  const promises = canvases.map((fabricCanvas, i) => {
    return new Promise((resolve) => {
      const label = fabricCanvas.lowerCanvasEl.parentElement.querySelector('input.label').value;
      let dataURL = fabricCanvas.toDataURL({ format: 'png', quality: 0.92 });
      let blob = dataURLToBlob(dataURL);

      if (blob.size > 1024 * 1024) {
        dataURL = fabricCanvas.toDataURL({ format: 'png', quality: 0.5 });
        blob = dataURLToBlob(dataURL);
      }

      zip.file(label + ".png", blob);
      resolve();
    });
  });

  Promise.all(promises).then(() => {
    zip.generateAsync({type:"blob"}).then(function(content) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(content);
      a.download = "images.zip";
      a.click();
    });
  });
}

createBoxes();
</script>

</body>
</html>
