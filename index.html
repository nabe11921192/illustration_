<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>6枠画像エディタ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      background-color: #f9f9f9;
    }
    .toolbar {
      position: fixed;
      top: 10px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
    }
    button {
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(3, 370px);
      grid-template-rows: repeat(2, 340px);
      gap: 40px 10px;
      justify-content: center;
      margin: 140px auto 20px auto;
    }
    .box {
      position: relative;
      border: 2px dashed #999;
      background-color: #eee;
      width: 370px;
      height: 320px;
    }
    .label {
      display: block;
      width: 100%;
      text-align: center;
      font-size: 14px;
      margin-top: 4px;
    }
    #imageHolder {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px;
      justify-content: center;
    }
    #saveAll {
      display: block;
      margin: 20px auto;
      font-size: 18px;
      padding: 10px 20px;
    }
    .version {
      position: fixed;
      bottom: 5px;
      right: 10px;
      font-size: 12px;
      color: #888;
    }
  </style>
</head>
<body>

<div class="toolbar">
  <button onclick="resetAll()">リセット</button>
  <button onclick="changeLabels(-6)">< 戻る</button>
  <button onclick="changeLabels(6)">進む ></button>
</div>

<h2 style="text-align:center;">画像を6つの枠にドラッグ＆ドロップ、編集</h2>
<div class="container" id="canvasContainer"></div>

<input type="file" id="fileInput" multiple onchange="loadImages(event)">
<div id="imageHolder"></div>

<button id="saveAll" onclick="saveAllImages()">画像表示（右クリック保存）</button>
<div class="version">Ver.1</div>

<script>
let labelOffset = 0;
const boxCount = 6;
const canvases = [];

function createBoxes() {
  const container = document.getElementById('canvasContainer');
  container.innerHTML = '';
  canvases.length = 0;
  for (let i = 0; i < boxCount; i++) {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.alignItems = 'center';

    const div = document.createElement('div');
    div.className = 'box';
    div.id = 'box' + i;

    const canvasEl = document.createElement('canvas');
    canvasEl.width = 370;
    canvasEl.height = 320;
    canvasEl.id = 'canvas' + i;
    div.appendChild(canvasEl);
    wrapper.appendChild(div);

    const label = document.createElement('input');
    label.className = 'label';
    label.value = (i + 1 + labelOffset).toString();
    wrapper.appendChild(label);
    container.appendChild(wrapper);

    const fabricCanvas = new fabric.Canvas(canvasEl.id, {
      selection: true,
      preserveObjectStacking: true
    });
    canvases.push(fabricCanvas);

    div.ondragover = e => e.preventDefault();
    div.ondrop = function(e) {
      e.preventDefault();
      const files = e.dataTransfer.files;
      if (files && files.length > 0) {
        const file = files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
          fabric.Image.fromURL(evt.target.result, function(fabricImg) {
            fabricImg.set({
              left: 0,
              top: 0,
              scaleX: 370 / fabricImg.width,
              scaleY: 320 / fabricImg.height
            });
            fabricCanvas.add(fabricImg);
            fabricCanvas.setActiveObject(fabricImg);
          });
        };
        reader.readAsDataURL(file);
      } else {
        const imgId = e.dataTransfer.getData("imgId");
        const imgEl = document.getElementById(imgId);
        if (!imgEl) return;
        fabric.Image.fromURL(imgEl.src, function(fabricImg) {
          fabricImg.set({
            left: 0,
            top: 0,
            scaleX: 370 / fabricImg.width,
            scaleY: 320 / fabricImg.height
          });
          fabricCanvas.add(fabricImg);
          fabricCanvas.setActiveObject(fabricImg);
        });
      }
    };

    fabricCanvas.on('mouse:down', function(opt) {
      fabricCanvas.setActiveObject(opt.target);
      if (opt.target) {
        opt.target.bringToFront();
      }
    });

    window.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace') {
        const active = fabricCanvas.getActiveObject();
        if (active) {
          fabricCanvas.remove(active);
        }
      }
    });
  }
}

function loadImages(e) {
  const files = e.target.files;
  const holder = document.getElementById("imageHolder");
  holder.innerHTML = "";
  Array.from(files).forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = function(evt) {
      const img = document.createElement("img");
      img.src = evt.target.result;
      img.id = "img" + i;
      img.draggable = true;
      img.style.width = "100px";
      img.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("imgId", img.id);
      });
      holder.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
}

function resetAll() {
  createBoxes();
}

function changeLabels(diff) {
  labelOffset += diff;
  const inputs = document.querySelectorAll('.label');
  inputs.forEach((input, i) => input.value = (i + 1 + labelOffset).toString());
}

function saveAllImages() {
  canvases.forEach((fabricCanvas, i) => {
    const label = fabricCanvas.lowerCanvasEl.parentElement.querySelector('input.label').value;
    fabricCanvas.discardActiveObject();
    fabricCanvas.renderAll();

    setTimeout(() => {
      const dataURL = fabricCanvas.toDataURL({ format: 'png', quality: 1.0 });
      const newWindow = window.open();
      newWindow.document.write(`<title>${label}.png</title>`);
      newWindow.document.write(`<p>右クリックして「名前を付けて画像を保存」してください</p>`);
      newWindow.document.write(`<img src="${dataURL}" style="width:370px; height:320px; image-rendering:pixelated;">`);
    }, 0);
  });
}

createBoxes();
</script>

</body>
</html>
